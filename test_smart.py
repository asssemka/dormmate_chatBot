import requests
import time


def test_smart_chatbot():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç —É–º–Ω—ã–π —á–∞—Ç–±–æ—Ç —Å —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–º —è–∑—ã–∫–æ–º"""
    base_url = "http://localhost:8000"

    print("üß† –¢–ï–°–¢–ò–†–£–ï–ú –£–ú–ù–´–ô AI –ß–ê–¢–ë–û–¢ –° –†–ê–ó–ì–û–í–û–†–ù–´–ú –Ø–ó–´–ö–û–ú")
    print("=" * 80)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
    try:
        response = requests.get(f"{base_url}/")
        info = response.json()
        print("üìä –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û–ë –£–ú–ù–û–ô –ú–û–î–ï–õ–ò:")
        for key, value in info.items():
            print(f"   {key}: {value}")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {e}")
        return

    # –¢–µ—Å—Ç–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã —Å —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–º —è–∑—ã–∫–æ–º
    test_questions = [
        # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã
        "–ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –æ–±—â–µ–∂–∏—Ç–∏–µ –î–°3?",
        "–ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –æ–±—â–µ–∂–∏—Ç–∏–µ –î–°2–∞?",
        "–ú–Ω–µ –Ω–µ –¥–∞–ª–∏ –æ–±—â–µ–∂–∏—Ç–∏–µ",

        # –†–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å "–æ–±—â–∞–≥–∞"
        "–ì–¥–µ –î–°3?",
        "–ß–µ –∑–∞ –∞–¥—Ä–µ—Å —É –î–°2–∞?",
        "–ö—É–¥–∞ –µ—Ö–∞—Ç—å –µ—Å–ª–∏ –¥–∞–ª–∏ –º–µ—Å—Ç–æ –≤ –î–°3?",
        "–ù–µ –¥–∞–ª–∏ –æ–±—â–∞–≥—É, —á–µ –¥–µ–ª–∞—Ç—å?",
        "–ö–∞–∫ –ø–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –æ–±—â–∞–≥—É?",
        "–ß–µ –Ω—É–∂–Ω–æ –¥–ª—è –æ–±—â–∞–≥–∏?",
        "–ö–∞–∫–∏–µ –æ–±—â–∞–≥–∏ –µ—Å—Ç—å?",
        "–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –æ–±—â–∞–≥",
        "–°–∫–æ–ª—å–∫–æ –æ–±—â–∞–≥ –≤ —É–Ω–∏–≤–µ—Ä–µ?",

        # –í–∞—Ä–∏–∞–Ω—Ç—ã —Å "–¥–æ–º —Å—Ç—É–¥–µ–Ω—Ç–æ–≤"
        "–ì–¥–µ –¥–æ–º —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ 3?",
        "–ê–¥—Ä–µ—Å —Å—Ç—É–¥–¥–æ–º–∞ 2–∞?",
        "–ö–∞–∫ –ø–æ–ø–∞—Å—Ç—å –≤ —Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–∏–π –¥–æ–º?",

        # –°–æ–∫—Ä–∞—â–µ–Ω–∏—è –∏ —Å–∫–ª–æ–Ω–µ–Ω–∏—è
        "–ì–¥–µ –¥—Å 3?",
        "–ê–¥—Ä–µ—Å –¥—Å-2–±?",
        "–í –∫–∞–∫–æ–π –æ–±—â–∞–≥–µ –ª—É—á—à–µ?",
        "–û–±—â–∞–≥–∞—Ö –∫–∞–∫–∏—Ö –∞–¥—Ä–µ—Å–∞?",
        "–û–±—â–µ–∂–∏—Ç–∏–π —Å–∫–æ–ª—å–∫–æ?",
        "–ñ–∏–ª—å–µ —Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–æ–µ –≥–¥–µ?",

        # –ù–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã
        "–ö–∞–∫ –ø–æ–¥–∞—Ç—å –∞–ø–µ–ª–ª—è—Ü–∏—é –Ω–∞ –æ—Ç–∫–∞–∑ –≤ –æ–±—â–∞–≥–µ?",
        "–°–∫–æ–ª—å–∫–æ –º–µ—Å—Ç –≤ –∫–æ–º–Ω–∞—Ç–∞—Ö –æ–±—â–∞–≥?",
        "–ß–µ –º–æ–∂–Ω–æ –≤–∑—è—Ç—å —Å —Å–æ–±–æ–π –≤ –æ–±—â–∞–≥—É?",
        "–ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è –≤ –æ–±—â–∞–≥–∞—Ö",
        "–°—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—â–∞–≥–∏",

        # –í–æ–ø—Ä–æ—Å—ã –¥–ª—è —Å—Ç–æ–ø-—Ñ—Ä–∞–∑
        "–ü—Ä–∏–≤–µ—Ç –∫–∞–∫ –¥–µ–ª–∞?",
        "–ö–∞–∫–∞—è –ø–æ–≥–æ–¥–∞?",
        "–ì–¥–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞?",
        "–†–∞—Å—Å–∫–∞–∂–∏ –∞–Ω–µ–∫–¥–æ—Ç",
        "–°–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏?",
        "–ß—Ç–æ –Ω–∞ –æ–±–µ–¥?",

        # –û—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã
        "–ß–µ?",
        "–ß—Ç–æ?",
        "–ö–∞–∫?",
        "–û–±—â–∞–≥–∞?",
        "",
        "   "
    ]

    print(f"\nüß™ –¢–ï–°–¢–ò–†–£–ï–ú {len(test_questions)} –£–ú–ù–´–• –í–û–ü–†–û–°–û–í:")
    print("=" * 80)

    results = {
        "database_answers": 0,
        "model_answers": 0,
        "stop_phrases": 0,
        "high_confidence": 0,
        "total_time": 0
    }

    for i, question in enumerate(test_questions, 1):
        print(f"\nüìù –£–ú–ù–´–ô –¢–ï–°–¢ {i}/{len(test_questions)}")
        print(f"‚ùì –í–æ–ø—Ä–æ—Å: '{question}'")

        try:
            start = time.time()
            response = requests.post(
                f"{base_url}/chat",
                json={
                    "question": question,
                    "user_id": f"smart_user_{i}",
                    "max_tokens": 100
                },
                timeout=30
            )
            end = time.time()

            request_time = end - start
            results["total_time"] += request_time

            if response.status_code == 200:
                result = response.json()

                print(f"ü§ñ –û—Ç–≤–µ—Ç: {result['answer']}")
                print(f"üìä –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {result['confidence']:.2f}")
                print(f"‚è±Ô∏è –í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {result['generation_time']:.2f}—Å")
                print(f"üîß –ú–æ–¥–µ–ª—å: {result['model_info']}")
                print(f"üì° –ò—Å—Ç–æ—á–Ω–∏–∫: {result['source']}")
                print(f"‚è∞ –û–±—â–µ–µ –≤—Ä–µ–º—è: {request_time:.2f}—Å")

                # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                if result['source'] == 'database':
                    results["database_answers"] += 1
                else:
                    results["model_answers"] += 1

                if result['confidence'] > 0.8:
                    results["high_confidence"] += 1

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —Å—Ç–æ–ø-—Ñ—Ä–∞–∑—ã
                stop_keywords = ["–Ω–µ –∑–Ω–∞—é", "–Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏", "–≤—ã—Ö–æ–¥–∏—Ç –∑–∞ —Ä–∞–º–∫–∏", "–Ω–µ –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å"]
                if any(keyword in result['answer'].lower() for keyword in stop_keywords):
                    results["stop_phrases"] += 1
                    print("üõë –°–¢–û–ü-–§–†–ê–ó–ê –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞")

                # –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞
                if result['confidence'] > 0.8:
                    print("üåü –û–¢–õ–ò–ß–ù–û–ï –∫–∞—á–µ—Å—Ç–≤–æ")
                elif result['confidence'] > 0.6:
                    print("‚úÖ –•–û–†–û–®–ï–ï –∫–∞—á–µ—Å—Ç–≤–æ")
                elif result['confidence'] > 0.3:
                    print("‚ö†Ô∏è –°–†–ï–î–ù–ï–ï –∫–∞—á–µ—Å—Ç–≤–æ")
                else:
                    print("‚ùå –ù–ò–ó–ö–û–ï –∫–∞—á–µ—Å—Ç–≤–æ")

            else:
                print(f"‚ùå HTTP –û—à–∏–±–∫–∞: {response.status_code}")

        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞: {e}")

        print("-" * 80)

    # –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    print(f"\nüß† –°–¢–ê–¢–ò–°–¢–ò–ö–ê –£–ú–ù–û–ì–û –ß–ê–¢–ë–û–¢–ê:")
    print("=" * 80)
    print(f"üìä –í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤: {len(test_questions)}")
    print(f"üóÉÔ∏è –û—Ç–≤–µ—Ç–æ–≤ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {results['database_answers']}")
    print(f"ü§ñ –û—Ç–≤–µ—Ç–æ–≤ –æ—Ç –º–æ–¥–µ–ª–∏: {results['model_answers']}")
    print(f"üõë –°—Ç–æ–ø-—Ñ—Ä–∞–∑: {results['stop_phrases']}")
    print(f"üåü –í—ã—Å–æ–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {results['high_confidence']}")
    print(f"‚è±Ô∏è –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è: {results['total_time'] / len(test_questions):.2f}—Å")

    # –û—Ü–µ–Ω–∫–∞ —Ä–∞–±–æ—Ç—ã
    database_percentage = (results['database_answers'] / len(test_questions)) * 100
    stop_percentage = (results['stop_phrases'] / len(test_questions)) * 100

    print(f"\nüìà –ê–ù–ê–õ–ò–ó:")
    print(f"üóÉÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: {database_percentage:.1f}%")
    print(f"üõë –°—Ç–æ–ø-—Ñ—Ä–∞–∑—ã: {stop_percentage:.1f}%")

    if stop_percentage > 20:
        print("‚úÖ –•–æ—Ä–æ—à–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–æ–ø-—Ñ—Ä–∞–∑—ã –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤")

    if database_percentage > 60:
        print("‚úÖ –•–æ—Ä–æ—à–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö")

    print("\nüéâ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –£–ú–ù–û–ì–û –ß–ê–¢–ë–û–¢–ê –ó–ê–í–ï–†–®–ï–ù–û!")


if __name__ == "__main__":
    test_smart_chatbot()

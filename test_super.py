import requests
import time


def test_perfect_chatbot():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –∏–¥–µ–∞–ª—å–Ω–æ —Ç–æ—á–Ω—ã–π —á–∞—Ç–±–æ—Ç"""
    base_url = "http://localhost:8000"

    print("üéØ –¢–ï–°–¢–ò–†–£–ï–ú –ò–î–ï–ê–õ–¨–ù–û –¢–û–ß–ù–´–ô AI –ß–ê–¢–ë–û–¢")
    print("=" * 70)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
    try:
        response = requests.get(f"{base_url}/")
        info = response.json()
        print("üìä –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ú–û–î–ï–õ–ò:")
        for key, value in info.items():
            print(f"   {key}: {value}")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {e}")
        return

    # –¢–µ—Å—Ç–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã —Å —ç—Ç–∞–ª–æ–Ω–Ω—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏
    test_questions = [
        {
            "question": "–ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –æ–±—â–µ–∂–∏—Ç–∏–µ –î–°3?",
            "expected": "–û–±—â–µ–∂–∏—Ç–∏–µ ‚Ññ3 –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ –∞–¥—Ä–µ—Å—É: –≥. –ê–ª–º–∞—Ç—ã, –º–∫—Ä ‚Ññ1 81–ê."
        },
        {
            "question": "–ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –æ–±—â–µ–∂–∏—Ç–∏–µ –î–°2–∞?",
            "expected": "–û–±—â–µ–∂–∏—Ç–∏–µ –î–°2–ê –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ –∞–¥—Ä–µ—Å—É: –≥. –ê–ª–º–∞—Ç—ã, –¢–∞—É–≥—É–ª—å 32."
        },
        {
            "question": "–ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –æ–±—â–µ–∂–∏—Ç–∏–µ –î–°2–±?",
            "expected": "–û–±—â–µ–∂–∏—Ç–∏–µ –î–°2–± –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ –∞–¥—Ä–µ—Å—É: –≥. –ê–ª–º–∞—Ç—ã, –¢–∞—É–≥—É–ª—å 34."
        },
        {
            "question": "–ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –æ–±—â–µ–∂–∏—Ç–∏–µ –ï–º–µ–Ω?",
            "expected": "–û–±—â–µ–∂–∏—Ç–∏–µ –ï–º–µ–Ω –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ –∞–¥—Ä–µ—Å—É: –≥. –ê–ª–º–∞—Ç—ã, –º–∫—Ä ‚Ññ10 26/1."
        },
        {
            "question": "–ú–Ω–µ –Ω–µ –¥–∞–ª–∏ –æ–±—â–µ–∂–∏—Ç–∏–µ",
            "expected": "–†–µ–∫–æ–º–µ–Ω–¥—É—é –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –≤ –¥–µ–∫–∞–Ω–∞—Ç –∏–ª–∏ –æ—Ç–¥–µ–ª —Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –∏ –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–∞ –∑–∞—è–≤–∫–∏."
        },
        {
            "question": "–ö–∞–∫ –ø–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –æ–±—â–µ–∂–∏—Ç–∏–µ?",
            "expected": "–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –Ω–∞ —Å–∞–π—Ç–µ, –∑–∞–ø–æ–ª–Ω–∏–≤ –∞–Ω–∫–µ—Ç—É –∏ –ø—Ä–∏–ª–æ–∂–∏–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã."
        },
        {
            "question": "–ö–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω—É–∂–Ω—ã –¥–ª—è –æ–±—â–µ–∂–∏—Ç–∏—è?",
            "expected": "–ü–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ –ª–∏—á–Ω–æ—Å—Ç–∏, —Å–ø—Ä–∞–≤–∫–∞ –æ –¥–æ—Ö–æ–¥–∞—Ö —Å–µ–º—å–∏ –∏ —Å–ø—Ä–∞–≤–∫–∞ –æ –∑–∞—á–∏—Å–ª–µ–Ω–∏–∏ –≤ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç."
        },
        {
            "question": "–ö–∞–∫ –æ–ø–ª–∞—Ç–∏—Ç—å –æ–±—â–µ–∂–∏—Ç–∏–µ?",
            "expected": "–û–ø–ª–∞—Ç—É –º–æ–∂–Ω–æ –ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ —á–µ—Ä–µ–∑ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –∏–ª–∏ –±–∞–Ω–∫–æ–≤—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥ –ø–æ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞."
        },
        {
            "question": "–ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –æ—Ç–∫–∞–∑–∞–ª–∏ –≤ –æ–±—â–µ–∂–∏—Ç–∏–∏?",
            "expected": "–ú–æ–∂–Ω–æ –ø–æ–¥–∞—Ç—å –∞–ø–µ–ª–ª—è—Ü–∏—é –∏–ª–∏ —É—Ç–æ—á–Ω–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –º–µ—Å—Ç –≤ –¥—Ä—É–≥–∏—Ö –æ–±—â–µ–∂–∏—Ç–∏—è—Ö —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—é."
        },
        {
            "question": "–ú–æ–∂–Ω–æ –ª–∏ –ø–æ—Å–µ–ª–∏—Ç—å—Å—è –≤–¥–≤–æ—ë–º —Å –¥—Ä—É–≥–æ–º?",
            "expected": "–ü—Ä–∏ –ø–æ–¥–∞—á–µ –∑–∞—è–≤–∫–∏ —É–∫–∞–∂–∏—Ç–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è –ø–æ —Å–æ—Å–µ–¥—Å—Ç–≤—É. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è —É—á—Ç—ë—Ç –≤–∞—à–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø—Ä–∏ —Ä–∞—Å—Å–µ–ª–µ–Ω–∏–∏."
        },
        {
            "question": "–°–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫ –∂–∏–≤—ë—Ç –≤ –∫–æ–º–Ω–∞—Ç–µ?",
            "expected": "–ö–∞–∫ –ø—Ä–∞–≤–∏–ª–æ, –≤ –æ–¥–Ω–æ–π –∫–æ–º–Ω–∞—Ç–µ –ø—Ä–æ–∂–∏–≤–∞—é—Ç –æ—Ç –¥–≤—É—Ö –¥–æ —á–µ—Ç—ã—Ä—ë—Ö —á–µ–ª–æ–≤–µ–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ–±—â–µ–∂–∏—Ç–∏—è –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫–æ–º–Ω–∞—Ç—ã."
        },
        {
            "question": "–ê–¥—Ä–µ—Å –î–°3 –≤ –ê–ª–º–∞—Ç—ã",
            "expected": "–û–±—â–µ–∂–∏—Ç–∏–µ ‚Ññ3 –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ –∞–¥—Ä–µ—Å—É: –≥. –ê–ª–º–∞—Ç—ã, –º–∫—Ä ‚Ññ1 81–ê."
        }
    ]

    print(f"\nüß™ –¢–ï–°–¢–ò–†–£–ï–ú {len(test_questions)} –í–û–ü–†–û–°–û–í:")
    print("=" * 70)

    perfect_answers = 0
    good_answers = 0
    total_confidence = 0

    for i, test_case in enumerate(test_questions, 1):
        question = test_case["question"]
        expected = test_case["expected"]

        print(f"\nüìù –¢–ï–°–¢ {i}/{len(test_questions)}")
        print(f"‚ùì –í–æ–ø—Ä–æ—Å: {question}")
        print(f"üéØ –û–∂–∏–¥–∞–µ–º—ã–π: {expected}")

        try:
            start = time.time()
            response = requests.post(
                f"{base_url}/chat",
                json={
                    "question": question,
                    "user_id": f"perfect_student_{i}",
                    "max_tokens": 80
                },
                timeout=30
            )
            end = time.time()

            if response.status_code == 200:
                result = response.json()

                print(f"ü§ñ –û—Ç–≤–µ—Ç: {result['answer']}")
                print(f"üìä –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {result['confidence']:.2f}")
                print(f"‚è±Ô∏è –í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {result['generation_time']:.2f}—Å")
                print(f"üîß –ú–æ–¥–µ–ª—å: {result['model_info']}")
                print(f"üì° –û–±—â–µ–µ –≤—Ä–µ–º—è: {end - start:.2f}—Å")

                total_confidence += result['confidence']

                # –û—Ü–µ–Ω–∫–∞ —Ç–æ—á–Ω–æ—Å—Ç–∏
                if result['answer'] == expected:
                    print("üåü –ò–î–ï–ê–õ–¨–ù–û –¢–û–ß–ù–´–ô –û–¢–í–ï–¢!")
                    perfect_answers += 1
                elif result['answer'].lower().replace(" ", "") in expected.lower().replace(" ",
                                                                                           "") or expected.lower().replace(
                        " ", "") in result['answer'].lower().replace(" ", ""):
                    print("‚úÖ –•–û–†–û–®–ò–ô –û–¢–í–ï–¢")
                    good_answers += 1
                else:
                    print("‚ö†Ô∏è –ù–ï–¢–û–ß–ù–´–ô –û–¢–í–ï–¢")

            else:
                print(f"‚ùå HTTP –û—à–∏–±–∫–∞: {response.status_code}")

        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞: {e}")

        print("-" * 70)

    avg_confidence = total_confidence / len(test_questions) if test_questions else 0

    print(f"\nüéØ –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ò–î–ï–ê–õ–¨–ù–û –¢–û–ß–ù–û–ô –ú–û–î–ï–õ–ò:")
    print(f"üåü –ò–¥–µ–∞–ª—å–Ω–æ —Ç–æ—á–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: {perfect_answers}/{len(test_questions)}")
    print(f"‚úÖ –•–æ—Ä–æ—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤: {good_answers}/{len(test_questions)}")
    print(f"üìä –°—Ä–µ–¥–Ω—è—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {avg_confidence:.2f}")
    print(f"üî• –ü—Ä–æ—Ü–µ–Ω—Ç –∏–¥–µ–∞–ª—å–Ω—ã—Ö: {(perfect_answers / len(test_questions) * 100):.1f}%")
    print(f"üìà –û–±—â–∏–π —É—Å–ø–µ—Ö: {((perfect_answers + good_answers) / len(test_questions) * 100):.1f}%")

    if perfect_answers == len(test_questions):
        print("\nüéâ –ú–û–î–ï–õ–¨ –†–ê–ë–û–¢–ê–ï–¢ –ò–î–ï–ê–õ–¨–ù–û! 100% –¢–û–ß–ù–û–°–¢–¨!")
    elif perfect_answers >= len(test_questions) * 0.9:
        print("\nüéØ –ú–û–î–ï–õ–¨ –†–ê–ë–û–¢–ê–ï–¢ –ü–û–ß–¢–ò –ò–î–ï–ê–õ–¨–ù–û!")
    else:
        print("\n‚ö†Ô∏è –ú–û–î–ï–õ–¨ –ù–£–ñ–î–ê–ï–¢–°–Ø –í –î–û–†–ê–ë–û–¢–ö–ï")


if __name__ == "__main__":
    test_perfect_chatbot()
